# ツリー型 LLM チャット（SPA）機能要件設計書 v1.0

## 目的とスコープ

- 単一ユーザ前提の SPA で、ツリー（有向森）状に会話を構築・再利用できるチャット体験を提供する。グラフ編集、コンテキスト計算、AI 再計算、履歴管理を中核機能とする。

## 用語

- **ノード**：`system / user / assistant(AI)` のいずれかの役割を持つ会話単位。
- **エッジ**：常に **根 → 葉** 方向の有向辺。循環は禁止。
- **ルート**：親を持たないノード。
- **コンテキスト**：根から任意の葉への連続したパス、及びその上の各ノードのコンテンツやプロパティを含むもの。
- **名前付コンテキスト**：コンテキストの中で、ユーザが任意に名前（非ユニーク）を付けたもの。UI 右上に一覧表示。
- **プロジェクト**：ツリー群を束ねる単位（ID はプロジェクト内ユニーク）。

---

## 機能要件（FR）

### FR-グラフ・プロジェクト管理

- **FR-001** ノードとエッジは常に木構造をなす。
- **FR-002** 孤立ノードはルートとして扱う。
- **FR-003** ノード削除時、子部分木は削除せず同一プロジェクト内の新ルートとして残す。
- **FR-004** エッジ作成時は即時にサイクル検知を行い、検知した場合は作成を拒否し理由を提示する。
- **FR-005** ID はプロジェクト内でユニークとする。プロジェクト間コピー時は ID を振り直す。

### FR-ノード／AI パラメータ

- **FR-010** ノード役割は `system / user / assistant(AI)` の 3 種。
- **FR-011** AI ノードのパラメータは、作成時は Project のデフォルト値を継承する。また初めて親が設定された時、親のパラメータを継承する。
- **FR-012** AI パラメータの型は `model / temperature / topP` とする。
  - `model` は Project 初期化時にアプリ層から注入される。
  - `temperature` は 0.0 から 1.0 の範囲で、デフォルトは 0.7 とする。
  - `topP` は 0.0 から 1.0 の範囲で、デフォルトは 1.0 とする。
- **FR-013** パラメータ履歴は VO スナップショットを操作単位で保持（上限目安 20）。
- **FR-014** AI ノードが `再計算中` または `再計算待ち` の間、該当ノードの `model / temperature / topP` は編集不可。

### FR-Undo/Redo

- **FR-020** Undo/Redo は操作コマンド粒度で管理し、複合操作も一括復元可能とする。
- **FR-021** Undo/Redo スタック上限は概ね 20 操作。
- **FR-022** Undo 対象：ノード（作成／削除／位置移動／更新）、エッジ（作成／削除／親変更）、コンテキスト（追加／削除／更新）、AI 再計算操作（単体／下流一括）。
- **FR-023** Undo/Redo スタックはブラウザ再読込で消去（LocalStorage に永続化しない）。

### FR-コンテキスト

- **FR-030** コンテキストは「根 → ノード」の連続パスに沿う。逆流・不連続は禁止。
- **FR-031** エッジをクリックすると、対象ノードまでのパスに基づくコンテキストを即時計算・表示する。
- **FR-032** 名前付コンテキストは作成・列挙・選択できる（name は非ユニーク、順序維持用 ID を持つ）。
- **FR-033** ノード A からノード B へのエッジを作成する場合、
  - ノード A の根から A へのコンテキストを削除する。
  - B から始まる **任意のコンテキスト C** を、「**根から A までのコンテキスト**」と **C** をこの順に結合したものに更新する。
- **FR-034** ノード A を削除すると、
  - A が葉の場合、 A が属するコンテキスト C の末尾ノードの A を削除する。これ以外の処理は行わない。
  - A を通る **任意のコンテキスト C** について、「元の部分木の根から A の親までのパス」は C から削除される。
  - A がある部分木の根でない場合、その根から A の親までのコンテキストを新規作成する。
- **FR-035** ノード A からノード B へのエッジを削除する場合、
  - B を通る **任意のコンテキスト C** を、**C のうち B から葉まで** の部分コンテキストに更新する。
  - 元の部分木の根から A までのコンテキストを新規作成する。

### FR-非同期 AI 再計算（状態機械）

- **状態**：`通常` / `再計算中` / `再計算待ち` / `再計算エラー`

### FR-トリガと遷移

- **FR-040** 新規作成した **AI ノード** の **親を設定** したとき：

  - そのノードから **根までのパス上の AI ノードが全て `通常`** の場合、当該ノードは `再計算中` になる。
  - パス上に **`通常` でない AI ノード** がある場合、当該ノードは `再計算待ち` になる。
  - この操作を **Undo** すると、当該 AI ノードの **親は未設定** に戻り、開始済みの再計算(非同期処理)は **中断**、状態は `通常` に戻る。

- **FR-041** `通常`または`エラー`のAI ノードの **再計算ボタン** を押すと、当該ノードは `再計算中` となり、当該ノードの **全ての子孫 AI ノード** は `再計算待ち` となる。**Undo** すると、`再計算中` / `再計算待ち` にした **全ての AI ノード** をその前の状態(`通常`または`エラー`)に戻し、**AI コンテンツを再計算前に戻す**。

- **FR-042** AI ノードが `再計算中` になると、**根 → 当該ノード** のコンテキストに基づいて再計算を開始し、終了時に `通常` に戻る（成功時）。

- **FR-043** `再計算待ち` の AI ノードは、**根 → そのノードの親** までのパスに含まれる **全ての AI ノードが `通常`** になると `再計算中` に遷移する（上流から順に自動進行）。

- **FR-044** 再計算中に **エラー** が発生した場合、当該ノードは `再計算エラー` となる。**リトライ** ボタンで `再計算中` に遷移し再試行する。

- **FR-045** `再計算中` または `再計算待ち` の間、当該 AI ノードの `model / temperature / topP` は編集不可（FR-014 と同義、明示）。

### FR-操作制約

- **FR-050** 根以外のノード A について、次の条件を満たすときは **A← 親** のエッジを削除できない。**A の親** も同条件では変更できない：

  - **A→ 根** のパス上に、`通常` でない AI ノードが **一つでも存在** する。

### FR-永続化・容量管理

- **FR-060** 永続化は LocalStorage（JSON）。容量上限超過時は保存を拒否し、エラーを通知する。
- **FR-061** LocalStorage の空きが **約 0.5MiB を下回った** 場合、以下の操作を受け付けない:
  - **新規作成**（ノード／エッジ／名前付コンテキストなど）
  - **コンテキスト編集**
  - **AI ノード再計算**
  - **Undo/Redo**
