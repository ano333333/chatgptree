# ツリー型 LLM チャット（SPA）機能要件設計書 v1.0

## 目的とスコープ

- 単一ユーザ前提の SPA で、ツリー（有向森）状に会話を構築・再利用できるチャット体験を提供する。グラフ編集、コンテキスト計算、AI 再計算、履歴管理を中核機能とする。

## 用語

- **ノード**：`system / user / assistant(AI)` のいずれかの役割を持つ会話単位。
- **コンテンツ**：ノードの内容テキスト。
- **ルート**：親を持たないノード。
- **プロジェクト**：ツリー群を束ねる単位（ID はプロジェクト内ユニーク）。

---

## 機能要件（FR）

### FR-グラフ・プロジェクト管理

- **FR-001** プロジェクトに含まれるノードは常に森構造をなす。
- **FR-002** 孤立ノードはルートとして扱う。
- **FR-003** ノード削除時、子部分木は削除せず同一プロジェクト内の新しい木として残す。
- **FR-004** ノードからノードへのエッジ作成時は即時にサイクル検知を行い、検知した場合は作成を拒否し理由を提示する。
- **FR-005** ID はプロジェクト内でユニークとする。プロジェクト間コピー時は ID を振り直す。

### FR-ノード／AI パラメータ

- **FR-010** ノード役割は `system / user / assistant(AI)` の 3 種。
- **FR-011** AI ノードのパラメータは、作成時は Project のデフォルト値を継承する。また初めて親が設定された時、親のパラメータを継承する。
- **FR-012** AI パラメータの型は `model / temperature / topP` とする。
  - `model` は Project 初期化時にアプリ層から注入される。
  - `temperature` は 0.0 から 1.0 の範囲で、デフォルトは 0.7 とする。
  - `topP` は 0.0 から 1.0 の範囲で、デフォルトは 1.0 とする。
- **FR-013** パラメータ履歴は VO スナップショットを操作単位で保持（上限目安 20）。

### FR-Undo/Redo

- **FR-020** Undo/Redo は操作コマンド粒度で管理し、複合操作も一括復元可能とする。
- **FR-021** Undo/Redo スタック上限は概ね 20 操作。
- **FR-022** Undo 対象：ノード（作成／削除／位置移動／コンテンツ更新／AI ノードのプロパティ更新）、AI 再計算操作。
- **FR-023** Undo/Redo スタックはブラウザ再読込で消去（LocalStorage に永続化しない）。

### FR-非同期 AI 再計算（状態機械）

- **状態**：`通常` / `再計算中` / `再計算待ち` / `再計算エラー`

### FR-トリガと遷移

- **FR-030** 新規作成した **AI ノード** の **親を設定** したとき：

  - そのノードから **根までのパス上の AI ノードが全て `通常`** の場合、当該ノードは `再計算中` になる。
  - パス上に **`通常` でない AI ノード** がある場合、当該ノードは `再計算待ち` になる。
  - この操作を **Undo** すると、当該 AI ノードの **親は未設定** に戻り、開始済みの再計算(非同期処理)は **中断**、状態は `通常` に戻る。

- **FR-031** `通常`または`エラー`のAI ノードの **再計算ボタン** を押すと、当該ノードは `再計算中` となり、当該ノードの **全ての子孫 AI ノード** は `再計算待ち` となる。**Undo** すると、`再計算中` / `再計算待ち` にした **全ての AI ノード** をその前の状態(`通常`または`エラー`)に戻し、**コンテンツを再計算前に戻す**。

- **FR-032** AI ノードが `再計算中` になると、**根 → 当該ノード** を辿り、それぞれのコンテンツを順に並べたテキストに基づいて再計算を開始する。終了時に `通常` に戻る（成功時）。

- **FR-033** `再計算待ち` の AI ノードは、**根 → そのノードの親** までのパスに含まれる **全ての AI ノードが `通常`** になると `再計算中` に遷移する（上流から順に自動進行）。

- **FR-034** 再計算中に **エラー** が発生した場合、当該ノードは `再計算エラー` となる。**リトライ** ボタンで `再計算中` に遷移し再試行する。

- **FR-035** `再計算中` または `再計算待ち` の間、当該 AI ノードの `model / temperature / topP` は編集不可（FR-014 と同義、明示）。

- **FR-036** `再計算中` または `再計算待ち` のAIノードのコンテンツは **永続化しない**。

- **FR-037** ページを閉じた時 `再計算中` だったノードについて、ページを開き直した際は**再度始めから計算をスタートする**。

### FR-操作制約

- **FR-040** 根以外のノード A について、次の条件を満たすときは **親 → A** のエッジを削除できない。**A の親** も同条件では変更できない：

  - **根 → A** のパス上に、`通常` でない AI ノードが **一つでも存在** する。

### FR-永続化・容量管理

- **FR-050** 永続化は LocalStorage（JSON）。容量上限超過時は保存を拒否し、エラーを通知する。
- **FR-051** LocalStorage の空きが **約 0.5MiB を下回った** 場合、以下の操作を受け付けない:
  - **ノード、プロジェクトの新規作成**
  - **ノード、プロジェクトの編集**
  - **AI ノード再計算**
  - **Undo/Redo**
